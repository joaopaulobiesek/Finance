<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o Mensal - Wiesoo Financeiro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 32px;
        }

        .btn-voltar {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 25px;
            border-radius: 25px;
            text-decoration: none;
            transition: all 0.3s;
        }

        .btn-voltar:hover {
            background: white;
            color: #667eea;
        }

        .content {
            padding: 40px;
        }

        .filtro-mes {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);
            border: 3px solid #667eea;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }

        .filtro-mes h2 {
            color: #667eea;
            font-size: 24px;
        }

        .filtro-mes input {
            padding: 12px 20px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            cursor: pointer;
        }

        .resumo-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .card-resumo {
            padding: 25px;
            border-radius: 15px;
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .card-resumo.receber {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        .card-resumo.pagar {
            background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
        }

        .card-resumo.saldo {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }

        .card-resumo h3 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .card-resumo p {
            font-size: 32px;
            font-weight: bold;
        }

        .card-resumo small {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            opacity: 0.8;
        }

        .secao {
            margin-bottom: 40px;
        }

        .secao-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
        }

        .secao-header.receber {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(69, 160, 73, 0.1) 100%);
            border-left: 5px solid #4CAF50;
        }

        .secao-header.pagar {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.1) 0%, rgba(218, 25, 11, 0.1) 100%);
            border-left: 5px solid #f44336;
        }

        .secao-header h2 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .secao-header h2.receber {
            color: #4CAF50;
        }

        .secao-header h2.pagar {
            color: #f44336;
        }

        .secao-header .total {
            font-size: 28px;
            font-weight: bold;
        }

        .lista-items {
            display: grid;
            gap: 15px;
        }

        .item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            align-items: center;
            gap: 20px;
            transition: all 0.3s;
        }

        .item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102,126,234,0.2);
            transform: translateY(-2px);
        }

        .item-icone {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .item-icone.receber {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .item-icone.pagar {
            background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
            color: white;
        }

        .item-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .item-info strong {
            font-size: 16px;
            color: #333;
        }

        .item-info small {
            color: #666;
            font-size: 13px;
        }

        .item-valor {
            font-size: 24px;
            font-weight: bold;
            white-space: nowrap;
        }

        .item-valor.receber {
            color: #4CAF50;
        }

        .item-valor.pagar {
            color: #f44336;
        }

        .item-acoes {
            display: flex;
            gap: 8px;
        }

        .btn-acao {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-pago {
            background: #4CAF50;
            color: white;
        }

        .btn-pago:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        .btn-pendente {
            background: #FF9800;
            color: white;
        }

        .btn-pendente:hover {
            background: #F57C00;
            transform: scale(1.05);
        }

        .btn-nao-pago {
            background: #f44336;
            color: white;
        }

        .btn-nao-pago:hover {
            background: #da190b;
            transform: scale(1.05);
        }

        .badge-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
        }

        .badge-pago {
            background: #4CAF50;
            color: white;
        }

        .badge-pendente {
            background: #FF9800;
            color: white;
        }

        .badge-nao-pago {
            background: #f44336;
            color: white;
        }

        .vazio {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            font-size: 18px;
        }

        .vazio-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        @media (max-width: 768px) {
            .item {
                grid-template-columns: auto 1fr;
                gap: 15px;
            }

            .item-valor {
                grid-column: 1 / -1;
                text-align: center;
                font-size: 20px;
            }

            .item-acoes {
                grid-column: 1 / -1;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÖ Gest√£o Mensal</h1>
            <a href="index.html" class="btn-voltar">‚Üê Voltar ao Menu</a>
        </div>

        <div class="content">
            <!-- Filtro de M√™s -->
            <div class="filtro-mes">
                <h2>üóìÔ∏è Selecione o M√™s</h2>
                <input type="month" id="filtroMes" onchange="carregarDadosMensais()">
            </div>

            <!-- Cards de Resumo -->
            <div class="resumo-cards">
                <div class="card-resumo receber">
                    <h3>üí∞ A Receber</h3>
                    <p id="totalReceber">R$ 0,00</p>
                    <small id="qtdReceber">0 pendentes</small>
                </div>
                <div class="card-resumo pagar">
                    <h3>üí∏ A Pagar</h3>
                    <p id="totalPagar">R$ 0,00</p>
                    <small id="qtdPagar">0 pendentes</small>
                </div>
                <div class="card-resumo saldo">
                    <h3>üíé Saldo do M√™s</h3>
                    <p id="saldoPrevisto">R$ 0,00</p>
                    <small id="saldoDescricao">Receitas - Despesas</small>
                </div>
            </div>

            <!-- Se√ß√£o: Receitas -->
            <div class="secao">
                <div class="secao-header receber">
                    <h2 class="receber">üí∞ Receitas do M√™s</h2>
                    <span class="total" style="color: #4CAF50;" id="totalReceberTexto">R$ 0,00</span>
                </div>
                <div class="lista-items" id="listaReceber">
                    <!-- Preenchido via JavaScript -->
                </div>
            </div>

            <!-- Se√ß√£o: Despesas -->
            <div class="secao">
                <div class="secao-header pagar">
                    <h2 class="pagar">üí∏ Despesas do M√™s</h2>
                    <span class="total" style="color: #f44336;" id="totalPagarTexto">R$ 0,00</span>
                </div>
                <div class="lista-items" id="listaPagar">
                    <!-- Preenchido via JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let config = null;

        document.addEventListener('DOMContentLoaded', async function() {
            config = await carregarConfig();

            // Definir m√™s atual como padr√£o
            const hoje = new Date();
            const mesAtual = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('filtroMes').value = mesAtual;

            await carregarDadosMensais();
        });

        async function carregarDadosMensais() {
            const mesSelecionado = document.getElementById('filtroMes').value;

            if (!mesSelecionado) {
                return;
            }

            const lancamentos = obterLancamentos();
            console.log('Total de lan√ßamentos:', lancamentos.length);

            // Filtrar lan√ßamentos do m√™s (usa competenciaFatura ou dataVencimento)
            const lancamentosMes = lancamentos.filter(l => {
                const competencia = obterCompetenciaLancamento(l);
                return competencia.startsWith(mesSelecionado);
            });

            console.log('Lan√ßamentos do m√™s ' + mesSelecionado + ':', lancamentosMes.length);
            console.log('Lan√ßamentos do m√™s:', lancamentosMes);

            // Separar TODAS as receitas e despesas do m√™s (independente do status)
            const receitas = lancamentosMes.filter(l => l.valor > 0);
            const despesas = lancamentosMes.filter(l => l.valor < 0);

            console.log('Todas as receitas:', receitas);
            console.log('Todas as despesas:', despesas);

            // Calcular totais APENAS N√ÉO PAGOS para os cards de resumo
            const receitasNaoPagas = receitas.filter(l => l.statusId === 2 || l.statusId === 3);
            const despesasNaoPagas = despesas.filter(l => l.statusId === 2 || l.statusId === 3);

            const totalReceber = receitasNaoPagas.reduce((sum, l) => sum + l.valor, 0);
            const totalPagar = despesasNaoPagas.reduce((sum, l) => sum + Math.abs(l.valor), 0);
            const saldoPrevisto = totalReceber - totalPagar;

            // Atualizar cards (apenas n√£o pagos)
            document.getElementById('totalReceber').textContent = formatarReal(totalReceber);
            document.getElementById('qtdReceber').textContent = `${receitasNaoPagas.length} pendente${receitasNaoPagas.length !== 1 ? 's' : ''}`;

            document.getElementById('totalPagar').textContent = formatarReal(totalPagar);
            document.getElementById('qtdPagar').textContent = `${despesasNaoPagas.length} pendente${despesasNaoPagas.length !== 1 ? 's' : ''}`;

            // Calcular saldo GERAL do m√™s (todos os lan√ßamentos)
            const totalGeralReceitas = receitas.reduce((sum, l) => sum + l.valor, 0);
            const totalGeralDespesas = despesas.reduce((sum, l) => sum + Math.abs(l.valor), 0);
            const saldoGeral = totalGeralReceitas - totalGeralDespesas;

            // Card de saldo mostra o saldo GERAL do m√™s
            document.getElementById('saldoPrevisto').textContent = formatarReal(saldoGeral);
            document.getElementById('saldoPrevisto').style.color = saldoGeral >= 0 ? '#4CAF50' : '#f44336';

            // Atualizar descri√ß√£o do card baseado se tem pendentes
            if (receitasNaoPagas.length > 0 || despesasNaoPagas.length > 0) {
                document.getElementById('saldoDescricao').textContent = `Saldo geral (${receitasNaoPagas.length + despesasNaoPagas.length} pendente${(receitasNaoPagas.length + despesasNaoPagas.length) !== 1 ? 's' : ''})`;
            } else {
                document.getElementById('saldoDescricao').textContent = 'Tudo pago no m√™s!';
            }

            // Atualizar totais nas se√ß√µes (total de TODOS os lan√ßamentos)
            document.getElementById('totalReceberTexto').textContent = formatarReal(totalGeralReceitas);
            document.getElementById('totalPagarTexto').textContent = formatarReal(totalGeralDespesas);

            // Renderizar listas
            await renderizarReceitas(receitas);
            await renderizarDespesas(despesas);
        }

        async function renderizarReceitas(receitas) {
            const container = document.getElementById('listaReceber');
            container.innerHTML = '';

            if (receitas.length === 0) {
                container.innerHTML = `
                    <div class="vazio">
                        <div class="vazio-icon">üì≠</div>
                        <p>Nenhuma receita neste m√™s!</p>
                    </div>
                `;
                return;
            }

            // Ordenar por status (n√£o pagos primeiro) e depois por vencimento
            receitas.sort((a, b) => {
                // N√£o pagos (2,3) antes de pagos (1)
                if (a.statusId !== 1 && b.statusId === 1) return -1;
                if (a.statusId === 1 && b.statusId !== 1) return 1;

                // Mesma prioridade: ordenar por vencimento
                const dataA = new Date(obterCompetenciaLancamento(a));
                const dataB = new Date(obterCompetenciaLancamento(b));
                return dataA - dataB;
            });

            for (const l of receitas) {
                const categoria = await obterCategoriaPorId(l.categoriaId);
                const status = await obterStatusPorId(l.statusId);
                const vencimento = formatarVencimentoCurto(l);

                // Definir classe do badge baseado no status
                let badgeClass = 'badge-nao-pago';
                if (status.id === 1) badgeClass = 'badge-pago';
                if (status.id === 3) badgeClass = 'badge-pendente';

                // Gerar bot√µes baseado no status atual
                let botoesAcoes = '';
                if (status.id === 1) {
                    // Se est√° PAGO, pode voltar para N√£o Pago ou Pendente
                    botoesAcoes = `
                        <button class="btn-acao btn-nao-pago" onclick="alterarStatusRapido(${l.id}, 2)" title="Marcar como N√£o Pago">‚ùå N√£o Pago</button>
                        <button class="btn-acao btn-pendente" onclick="alterarStatusRapido(${l.id}, 3)" title="Marcar como Pendente">‚è≥ Pendente</button>
                    `;
                } else if (status.id === 2) {
                    // Se est√° N√ÉO PAGO, pode marcar como Pago ou Pendente
                    botoesAcoes = `
                        <button class="btn-acao btn-pago" onclick="alterarStatusRapido(${l.id}, 1)" title="Marcar como Pago">‚úÖ Pago</button>
                        <button class="btn-acao btn-pendente" onclick="alterarStatusRapido(${l.id}, 3)" title="Marcar como Pendente">‚è≥ Pendente</button>
                    `;
                } else {
                    // Se est√° PENDENTE, pode marcar como Pago ou N√£o Pago
                    botoesAcoes = `
                        <button class="btn-acao btn-pago" onclick="alterarStatusRapido(${l.id}, 1)" title="Marcar como Pago">‚úÖ Pago</button>
                        <button class="btn-acao btn-nao-pago" onclick="alterarStatusRapido(${l.id}, 2)" title="Marcar como N√£o Pago">‚ùå N√£o Pago</button>
                    `;
                }

                const item = document.createElement('div');
                item.className = 'item';
                // Adicionar opacidade se estiver pago
                if (status.id === 1) {
                    item.style.opacity = '0.6';
                }

                item.innerHTML = `
                    <div class="item-icone receber">üí∞</div>
                    <div class="item-info">
                        <strong>${l.descricao}</strong>
                        <small>
                            ${categoria ? categoria.nome : 'N/A'} |
                            Vencimento: ${vencimento} |
                            <span class="badge-status ${badgeClass}">${status.icone} ${status.nome}</span>
                        </small>
                    </div>
                    <div class="item-valor receber">${formatarReal(l.valor)}</div>
                    <div class="item-acoes">
                        ${botoesAcoes}
                    </div>
                `;
                container.appendChild(item);
            }
        }

        async function renderizarDespesas(despesas) {
            const container = document.getElementById('listaPagar');
            container.innerHTML = '';

            if (despesas.length === 0) {
                container.innerHTML = `
                    <div class="vazio">
                        <div class="vazio-icon">üì≠</div>
                        <p>Nenhuma despesa neste m√™s!</p>
                    </div>
                `;
                return;
            }

            // Ordenar por status (n√£o pagos primeiro) e depois por vencimento
            despesas.sort((a, b) => {
                // N√£o pagos (2,3) antes de pagos (1)
                if (a.statusId !== 1 && b.statusId === 1) return -1;
                if (a.statusId === 1 && b.statusId !== 1) return 1;

                // Mesma prioridade: ordenar por vencimento
                const dataA = new Date(obterCompetenciaLancamento(a));
                const dataB = new Date(obterCompetenciaLancamento(b));
                return dataA - dataB;
            });

            for (const l of despesas) {
                const categoria = await obterCategoriaPorId(l.categoriaId);
                const status = await obterStatusPorId(l.statusId);
                const vencimento = formatarVencimentoCurto(l);

                // Definir classe do badge baseado no status
                let badgeClass = 'badge-nao-pago';
                if (status.id === 1) badgeClass = 'badge-pago';
                if (status.id === 3) badgeClass = 'badge-pendente';

                // Gerar bot√µes baseado no status atual
                let botoesAcoes = '';
                if (status.id === 1) {
                    // Se est√° PAGO, pode voltar para N√£o Pago ou Pendente
                    botoesAcoes = `
                        <button class="btn-acao btn-nao-pago" onclick="alterarStatusRapido(${l.id}, 2)" title="Marcar como N√£o Pago">‚ùå N√£o Pago</button>
                        <button class="btn-acao btn-pendente" onclick="alterarStatusRapido(${l.id}, 3)" title="Marcar como Pendente">‚è≥ Pendente</button>
                    `;
                } else if (status.id === 2) {
                    // Se est√° N√ÉO PAGO, pode marcar como Pago ou Pendente
                    botoesAcoes = `
                        <button class="btn-acao btn-pago" onclick="alterarStatusRapido(${l.id}, 1)" title="Marcar como Pago">‚úÖ Pago</button>
                        <button class="btn-acao btn-pendente" onclick="alterarStatusRapido(${l.id}, 3)" title="Marcar como Pendente">‚è≥ Pendente</button>
                    `;
                } else {
                    // Se est√° PENDENTE, pode marcar como Pago ou N√£o Pago
                    botoesAcoes = `
                        <button class="btn-acao btn-pago" onclick="alterarStatusRapido(${l.id}, 1)" title="Marcar como Pago">‚úÖ Pago</button>
                        <button class="btn-acao btn-nao-pago" onclick="alterarStatusRapido(${l.id}, 2)" title="Marcar como N√£o Pago">‚ùå N√£o Pago</button>
                    `;
                }

                const item = document.createElement('div');
                item.className = 'item';
                // Adicionar opacidade se estiver pago
                if (status.id === 1) {
                    item.style.opacity = '0.6';
                }

                item.innerHTML = `
                    <div class="item-icone pagar">üí∏</div>
                    <div class="item-info">
                        <strong>${l.descricao}</strong>
                        <small>
                            ${categoria ? categoria.nome : 'N/A'} |
                            Vencimento: ${vencimento} |
                            <span class="badge-status ${badgeClass}">${status.icone} ${status.nome}</span>
                        </small>
                    </div>
                    <div class="item-valor pagar">${formatarReal(l.valor)}</div>
                    <div class="item-acoes">
                        ${botoesAcoes}
                    </div>
                `;
                container.appendChild(item);
            }
        }

        function formatarVencimentoCurto(lancamento) {
            if (lancamento.competenciaFatura) {
                const [ano, mes] = lancamento.competenciaFatura.split('-');
                return `${mes}/${ano}`;
            }
            if (lancamento.dataVencimento) {
                return formatarData(lancamento.dataVencimento);
            }
            return formatarData(lancamento.data);
        }

        async function alterarStatusRapido(id, novoStatusId) {
            const lancamento = obterLancamentoPorId(id);

            if (!lancamento) {
                alert('‚ùå Lan√ßamento n√£o encontrado!');
                return;
            }

            alterarStatusLancamento(id, novoStatusId);

            const status = await obterStatusPorId(novoStatusId);

            // Feedback visual
            const btn = event.target;
            const textoOriginal = btn.innerHTML;
            btn.innerHTML = `${status.icone} Feito!`;
            btn.disabled = true;

            setTimeout(async () => {
                await carregarDadosMensais();
            }, 500);
        }
    </script>
</body>
</html>
