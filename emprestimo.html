<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empr√©stimo - Wiesoo Financeiro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 32px;
        }

        .btn-voltar {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 25px;
            border-radius: 25px;
            text-decoration: none;
            transition: all 0.3s;
        }

        .btn-voltar:hover {
            background: white;
            color: #667eea;
        }

        .content {
            padding: 40px;
        }

        .form-section {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);
            border: 3px solid #667eea;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .form-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: #333;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card-stat {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .card-stat h3 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .card-stat p {
            font-size: 28px;
            font-weight: bold;
        }

        .chart-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .chart-section h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .historico-section {
            margin-top: 30px;
        }

        .historico-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 24px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        thead {
            background: #667eea;
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tbody tr:hover {
            background: #f8f9ff;
        }

        .alert-info {
            background: #e3f2fd;
            border: 2px solid #2196F3;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            color: #1565c0;
        }

        .btn-add {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin-top: 20px;
        }

        .btn-add:hover {
            background: #45a049;
        }

        .btn-delete {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-delete:hover {
            background: #da190b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí≥ Controle de Empr√©stimo</h1>
            <a href="index.html" class="btn-voltar">‚Üê Voltar ao Menu</a>
        </div>

        <div class="content">
            <!-- Formul√°rio de Dados do Empr√©stimo -->
            <div class="form-section">
                <h2>üìù Dados do Empr√©stimo</h2>
                <form id="formEmprestimo">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Valor Total Emprestado (R$)</label>
                            <input type="number" id="valorTotal" step="0.01" placeholder="Ex: 100000">
                        </div>
                        <div class="form-group">
                            <label>Parcela Mensal (R$)</label>
                            <input type="number" id="parcelaMensal" step="0.01" value="7000">
                        </div>
                        <div class="form-group">
                            <label>N√∫mero Total de Parcelas</label>
                            <input type="number" id="numeroParcelas" placeholder="Ex: 24">
                        </div>
                        <div class="form-group">
                            <label>Parcelas J√° Pagas</label>
                            <input type="number" id="parcelasPagas" value="0">
                        </div>
                    </div>
                    <button type="submit" class="btn-primary">üíæ Salvar Dados do Empr√©stimo</button>
                </form>
                
                <div class="alert-info">
                    <strong>üí° Dica:</strong> Mantenha estes dados atualizados para acompanhar corretamente o saldo devedor!
                </div>
            </div>

            <!-- Cards de Resumo -->
            <div class="cards-grid">
                <div class="card-stat">
                    <h3>Valor Total</h3>
                    <p id="cardValorTotal">R$ 0,00</p>
                </div>
                <div class="card-stat" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
                    <h3>Total J√° Pago</h3>
                    <p id="cardTotalPago">R$ 0,00</p>
                </div>
                <div class="card-stat" style="background: linear-gradient(135deg, #f44336 0%, #da190b 100%);">
                    <h3>Saldo Devedor</h3>
                    <p id="cardSaldoDevedor">R$ 0,00</p>
                </div>
                <div class="card-stat" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">
                    <h3>Parcelas Restantes</h3>
                    <p id="cardParcelasRestantes">0</p>
                </div>
            </div>

            <!-- Gr√°fico de Progresso -->
            <div class="chart-section">
                <h2>üìä Progresso do Pagamento</h2>
                <canvas id="chartProgresso"></canvas>
            </div>

            <!-- Hist√≥rico de Pagamentos -->
            <div class="historico-section">
                <h2>üìÖ Hist√≥rico de Pagamentos</h2>
                
                <button class="btn-add" onclick="mostrarFormPagamento()">‚ûï Adicionar Pagamento</button>

                <div id="formPagamentoDiv" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Novo Pagamento</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">M√™s/Ano</label>
                            <input type="text" id="mesPagamento" placeholder="Ex: Out/2025" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Data Pagamento</label>
                            <input type="date" id="dataPagamento" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Valor (R$)</label>
                            <input type="number" id="valorPagamento" step="0.01" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn-primary" onclick="adicionarPagamento()">üíæ Salvar Pagamento</button>
                        <button class="btn-primary" onclick="cancelarPagamento()" style="background: #999; margin-left: 10px;">‚ùå Cancelar</button>
                    </div>
                </div>

                <table id="tabelaHistorico" style="margin-top: 20px;">
                    <thead>
                        <tr>
                            <th>M√™s/Ano</th>
                            <th>Data Pagamento</th>
                            <th>Valor Pago</th>
                            <th>N¬∫ Parcela</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let graficoProgresso = null;
        let config = null;

        document.addEventListener('DOMContentLoaded', async function() {
            config = await carregarConfig();
            carregarDadosEmprestimo();
            document.getElementById('dataPagamento').valueAsDate = new Date();
        });

        function carregarDadosEmprestimo() {
            const emprestimo = obterEmprestimo();

            document.getElementById('valorTotal').value = emprestimo.valorTotal || '';
            document.getElementById('parcelaMensal').value = emprestimo.parcelaMensal || 7000;
            document.getElementById('numeroParcelas').value = emprestimo.numeroParcelas || '';
            document.getElementById('parcelasPagas').value = emprestimo.parcelasPagas || 0;

            atualizarCards(emprestimo);
            atualizarGrafico(emprestimo);
            carregarHistorico(emprestimo);
        }

        document.getElementById('formEmprestimo').addEventListener('submit', function(e) {
            e.preventDefault();

            const dados = {
                valorTotal: parseFloat(document.getElementById('valorTotal').value) || 0,
                parcelaMensal: parseFloat(document.getElementById('parcelaMensal').value) || 0,
                numeroParcelas: parseInt(document.getElementById('numeroParcelas').value) || 0,
                parcelasPagas: parseInt(document.getElementById('parcelasPagas').value) || 0
            };

            atualizarEmprestimo(dados);
            alert('‚úÖ Dados do empr√©stimo salvos com sucesso!');
            carregarDadosEmprestimo();
        });

        function atualizarCards(emprestimo) {
            const totalPago = (emprestimo.parcelasPagas || 0) * (emprestimo.parcelaMensal || 0);
            const saldoDevedor = (emprestimo.valorTotal || 0) - totalPago;
            const parcelasRestantes = (emprestimo.numeroParcelas || 0) - (emprestimo.parcelasPagas || 0);

            document.getElementById('cardValorTotal').textContent = formatarReal(emprestimo.valorTotal || 0);
            document.getElementById('cardTotalPago').textContent = formatarReal(totalPago);
            document.getElementById('cardSaldoDevedor').textContent = formatarReal(saldoDevedor);
            document.getElementById('cardParcelasRestantes').textContent = Math.max(0, parcelasRestantes);
        }

        function atualizarGrafico(emprestimo) {
            const pago = (emprestimo.parcelasPagas || 0) * (emprestimo.parcelaMensal || 0);
            const restante = (emprestimo.valorTotal || 0) - pago;

            const ctx = document.getElementById('chartProgresso').getContext('2d');

            if (graficoProgresso) {
                graficoProgresso.destroy();
            }

            graficoProgresso = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pago', 'Restante'],
                    datasets: [{
                        data: [pago, Math.max(0, restante)],
                        backgroundColor: ['#4CAF50', '#f44336'],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 14 },
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        function carregarHistorico(emprestimo) {
            const tbody = document.querySelector('#tabelaHistorico tbody');
            tbody.innerHTML = '';

            const historico = emprestimo.historico || [];

            if (historico.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px; color: #999;">Nenhum pagamento registrado ainda</td></tr>';
                return;
            }

            historico.forEach((pag, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${pag.mes}</td>
                    <td>${formatarData(pag.data)}</td>
                    <td style="color: #4CAF50; font-weight: bold;">${formatarReal(pag.valor)}</td>
                    <td>${pag.parcela}</td>
                    <td>
                        <button class="btn-delete" onclick="deletarPagamento(${index})">üóëÔ∏è Deletar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function mostrarFormPagamento() {
            document.getElementById('formPagamentoDiv').style.display = 'block';
            const emprestimo = obterEmprestimo();
            document.getElementById('valorPagamento').value = emprestimo.parcelaMensal || 7000;
        }

        function cancelarPagamento() {
            document.getElementById('formPagamentoDiv').style.display = 'none';
            document.getElementById('mesPagamento').value = '';
            document.getElementById('dataPagamento').valueAsDate = new Date();
            document.getElementById('valorPagamento').value = '';
        }

        function adicionarPagamento() {
            const mes = document.getElementById('mesPagamento').value;
            const data = document.getElementById('dataPagamento').value;
            const valor = parseFloat(document.getElementById('valorPagamento').value);

            if (!mes || !data || !valor) {
                alert('‚ùå Preencha todos os campos!');
                return;
            }

            const emprestimo = obterEmprestimo();
            const novaParcela = (emprestimo.historico || []).length + 1;

            const pagamento = {
                mes: mes,
                data: data,
                valor: valor,
                parcela: novaParcela
            };

            adicionarPagamentoEmprestimo(pagamento);
            
            // Atualizar parcelas pagas
            emprestimo.parcelasPagas = novaParcela;
            atualizarEmprestimo(emprestimo);

            alert('‚úÖ Pagamento adicionado com sucesso!');
            cancelarPagamento();
            carregarDadosEmprestimo();
        }

        function deletarPagamento(index) {
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja deletar este pagamento?')) {
                return;
            }

            const dados = carregarDados();
            dados.emprestimo.historico.splice(index, 1);
            
            // Recalcular parcelas pagas
            dados.emprestimo.parcelasPagas = dados.emprestimo.historico.length;
            
            salvarDados(dados);
            alert('‚úÖ Pagamento deletado!');
            carregarDadosEmprestimo();
        }
    </script>
</body>
</html>